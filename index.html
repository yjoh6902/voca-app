<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>단어 암기 앱</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .achievement-score {
            background: rgba(255,255,255,0.2);
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 1.2em;
            font-weight: bold;
            backdrop-filter: blur(10px);
        }

        .content {
            padding: 30px;
        }

        .settings-section {
            background: #f8f9ff;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid #e1e8ff;
        }

        .settings-title {
            font-size: 1.3em;
            color: #4a5568;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #2d3748;
            font-weight: 500;
        }

        .radio-group {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 8px;
            transition: background-color 0.2s;
        }

        .radio-option:hover {
            background-color: #e2e8f0;
        }

        .radio-option input[type="radio"] {
            margin: 0;
            cursor: pointer;
        }

        select {
            width: 100px;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            background: white;
            cursor: pointer;
            transition: border-color 0.2s;
        }

        select:focus {
            outline: none;
            border-color: #4facfe;
        }

        .quiz-type-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }

        .quiz-type-option {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .quiz-type-option:hover {
            border-color: #4facfe;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(79, 172, 254, 0.15);
        }

        .quiz-type-option.selected {
            border-color: #4facfe;
            background: #f0f9ff;
        }

        .buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 25px;
        }

        .btn {
            padding: 15px 25px;
            border: none;
            border-radius: 12px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(79, 172, 254, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(79, 172, 254, 0.6);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .game-area {
            background: #f8f9ff;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            min-height: 400px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            border: 1px solid #e1e8ff;
        }

        .status-text {
            font-size: 1.2em;
            color: #4a5568;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .word-display {
            font-size: 2.5em;
            font-weight: bold;
            color: #2d3748;
            margin: 20px 0;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .meaning-display {
            font-size: 1.5em;
            color: #4a5568;
            margin: 15px 0;
        }

        .feedback {
            font-size: 1.2em;
            margin: 15px 0;
            font-weight: 600;
            min-height: 25px;
        }

        .feedback.correct {
            color: #48bb78;
        }

        .feedback.incorrect {
            color: #f56565;
        }

        .feedback.warning {
            color: #ed8936;
        }

        .quiz-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin: 25px 0;
        }

        .quiz-option {
            padding: 15px 25px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1.1em;
        }

        .quiz-option:hover {
            border-color: #4facfe;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(79, 172, 254, 0.15);
        }

        .quiz-option.selected {
            border-color: #4facfe;
            background: #f0f9ff;
        }

        .quiz-option:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .answer-input {
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1.3em;
            text-align: center;
            width: 100%;
            max-width: 300px;
            margin: 20px auto;
            transition: border-color 0.2s;
        }

        .answer-input:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }

        .game-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 25px;
            flex-wrap: wrap;
        }

        .btn-action {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 120px;
        }

        .btn-submit {
            background: #48bb78;
            color: white;
        }

        .btn-submit:hover:not(:disabled) {
            background: #38a169;
            transform: translateY(-1px);
        }

        .btn-submit:disabled {
            background: #a0aec0;
            cursor: not-allowed;
        }

        .btn-next {
            background: #4facfe;
            color: white;
        }

        .btn-next:hover:not(:disabled) {
            background: #2b6cb0;
            transform: translateY(-1px);
        }

        .btn-next:disabled {
            background: #a0aec0;
            cursor: not-allowed;
        }

        .data-upload {
            background: #fff5f5;
            border: 2px dashed #fed7d7;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            text-align: center;
        }

        .upload-info {
            color: #e53e3e;
            margin-bottom: 15px;
            font-weight: 500;
        }

        .file-input {
            margin: 10px 0;
        }

        .sample-format {
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #4facfe;
            margin-top: 15px;
            text-align: left;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            color: #2d3748;
        }

        @media (max-width: 600px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }

            .content {
                padding: 20px;
            }

            .buttons {
                grid-template-columns: 1fr;
            }

            .quiz-type-grid {
                grid-template-columns: 1fr;
            }

            .radio-group {
                flex-direction: column;
                gap: 10px;
            }

            .word-display {
                font-size: 2em;
            }

            .game-buttons {
                flex-direction: column;
                align-items: center;
            }
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📚 단어 암기 앱</h1>
            <div class="achievement-score">
                🏆 성취점수: <span id="achievementScore">0</span>
            </div>
        </div>

        <div class="content">
            <!-- 데이터 업로드 섹션 -->
            <div class="data-upload">
                <div class="upload-info">📁 단어 데이터를 업로드하거나 샘플 데이터를 사용하세요</div>
                <input type="file" id="fileInput" accept=".txt" class="file-input">
                <button class="btn btn-secondary" onclick="loadSampleData()">샘플 데이터 사용</button>
                
                <div class="sample-format">
                    <strong>파일 형식 예시:</strong><br>
                    Total Achievement | 0<br><br>
                    Day 1<br>
                    apple - 사과<br>
                    book - 책<br><br>
                    Day 2<br>
                    water - 물<br>
                    house - 집
                </div>
            </div>

            <!-- 학습 설정 -->
            <div class="settings-section">
                <div class="settings-title">⚙️ 학습 설정</div>
                
                <div class="form-group">
                    <label>학습 모드:</label>
                    <div class="radio-group">
                        <div class="radio-option">
                            <input type="radio" name="learningMode" value="single" id="modeSingle" checked>
                            <label for="modeSingle">일별 학습</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" name="learningMode" value="comprehensive" id="modeComprehensive">
                            <label for="modeComprehensive">종합 학습</label>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="singleDay">학습할 Day:</label>
                    <select id="singleDay"></select>
                    
                    <label for="endDay" class="hidden" id="endDayLabel">종료 Day (시작: Day 1):</label>
                    <select id="endDay" class="hidden"></select>
                </div>

                <div class="form-group">
                    <label>퀴즈 유형:</label>
                    <div class="quiz-type-grid">
                        <div class="quiz-type-option selected" data-type="eng_to_kor">
                            <input type="radio" name="quizType" value="eng_to_kor" checked hidden>
                            영어 → 한글<br>(객관식)
                        </div>
                        <div class="quiz-type-option" data-type="kor_to_eng">
                            <input type="radio" name="quizType" value="kor_to_eng" hidden>
                            한글 → 영어<br>(객관식)
                        </div>
                        <div class="quiz-type-option" data-type="fill_blank">
                            <input type="radio" name="quizType" value="fill_blank" hidden>
                            빈칸 채우기<br>(주관식)
                        </div>
                        <div class="quiz-type-option" data-type="mixed">
                            <input type="radio" name="quizType" value="mixed" hidden>
                            종합 랜덤<br>(혼합)
                        </div>
                    </div>
                </div>
            </div>

            <!-- 모드 선택 버튼 -->
            <div class="buttons">
                <button class="btn btn-primary" onclick="startStudyMode()">
                    📖 단어 학습 (플래시카드)
                </button>
                <button class="btn btn-secondary" onclick="startQuizMode()">
                    🧠 단어 퀴즈
                </button>
            </div>

            <!-- 게임 영역 -->
            <div class="game-area">
                <div class="status-text" id="statusText">모드를 선택하세요</div>
                <div class="word-display" id="wordDisplay"></div>
                <div class="meaning-display" id="meaningDisplay"></div>
                <div class="feedback" id="feedback"></div>
                
                <!-- 퀴즈 옵션 (객관식) -->
                <div class="quiz-options hidden" id="quizOptions"></div>
                
                <!-- 답 입력 (주관식) -->
                <input type="text" class="answer-input hidden" id="answerInput" placeholder="답을 입력하세요">
                
                <!-- 게임 버튼 -->
                <div class="game-buttons">
                    <button class="btn-action btn-submit hidden" id="actionButton1"></button>
                    <button class="btn-action btn-next hidden" id="actionButton2"></button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 전역 변수
        let vocabulary = {};
        let statsData = {};
        let achievementData = { total: 0 };
        let currentDayWords = [];
        let currentWordIndex = 0;
        let score = 0;
        let currentDayInfo = "";
        let quizActive = false;
        let studyActive = false;
        let activeQuestionType = null;
        let selectedOption = null;
        let achievementScore = 0;

        // 초기화
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            loadFromStorage();
            updateAchievementDisplay();
        });

        function setupEventListeners() {
            // 파일 업로드
            document.getElementById('fileInput').addEventListener('change', handleFileUpload);
            
            // 모드 변경
            document.querySelectorAll('input[name="learningMode"]').forEach(radio => {
                radio.addEventListener('change', updateDaySelectionWidgets);
            });
            
            // 퀴즈 유형 선택
            document.querySelectorAll('.quiz-type-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.quiz-type-option').forEach(o => o.classList.remove('selected'));
                    this.classList.add('selected');
                    this.querySelector('input').checked = true;
                });
            });
            
            // 답 입력 필드
            document.getElementById('answerInput').addEventListener('input', onAnswerEntryChange);
            document.getElementById('answerInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !document.getElementById('actionButton1').disabled) {
                    document.getElementById('actionButton1').click();
                }
            });
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const content = e.target.result;
                    parseVocabularyData(content);
                };
                reader.readAsText(file, 'utf-8');
            }
        }

        function loadSampleData() {
            const sampleData = `Total Achievement | 0

Day 1
apple - 사과
book - 책
water - 물
house - 집
school - 학교

Day 2
computer - 컴퓨터
phone - 전화기
friend - 친구
family - 가족
love - 사랑

Day 3
beautiful - 아름다운
happy - 행복한
sad - 슬픈
angry - 화난
excited - 신난`;
            
            parseVocabularyData(sampleData);
        }

        function parseVocabularyData(content) {
            try {
                vocabulary = {};
                statsData = {};
                achievementData = { total: 0 };
                
                const lines = content.split('\n');
                let currentDay = null;
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;
                    
                    if (line.startsWith('Total Achievement')) {
                        const parts = line.split('|');
                        if (parts.length > 1 && parts[1] && parts[1].trim() !== "") {
                            try {
                                const score = parseInt(parts[1].trim());
                                achievementData.total = isNaN(score) ? 0 : score;
                                achievementScore = achievementData.total;
                            } catch (e) {
                                // Error during parseInt or trim, achievementData.total remains default (0)
                                // achievementScore will also be 0 based on initialization or previous value
                                console.warn("Could not parse achievement score from line:", line, e);
                                achievementData.total = achievementData.total || 0; // Ensure it's at least 0
                                achievementScore = achievementData.total;
                            }
                        } else {
                            // Line is "Total Achievement" or "Total Achievement | "
                            // Default to existing or 0 if not yet set.
                            achievementData.total = achievementData.total || 0;
                            achievementScore = achievementData.total;
                        }
                    } else if (line.toLowerCase().startsWith('day')) {
                        try {
                            const dayNum = parseInt(line.split(' ').pop());
                            currentDay = dayNum;
                            vocabulary[currentDay] = [];
                        } catch (e) {
                            currentDay = null;
                        }
                    } else if (currentDay !== null && line.includes(' - ')) {
                        const [eng, kor, stats] = parseVocabLine(line);
                        if (eng && kor) {
                            vocabulary[currentDay].push([eng, kor]);
                            statsData[`${eng}|${kor}`] = stats;
                        }
                    }
                }
                
                updateDaySelections();
                updateAchievementDisplay();
                saveToStorage();
                
                alert('단어 데이터가 성공적으로 로드되었습니다!');
            } catch (error) {
                alert('파일 형식이 올바르지 않습니다.');
                console.error(error);
            }
        }

        function parseVocabLine(line) {
            let main = line;
            let stats = [0, 0, 0];
            
            if (line.includes('|')) {
                const parts = line.split('|');
                main = parts[0].trim();
                if (parts.length > 1 && parts[1].trim() !== "") { // Check if there's anything after |
                    try {
                        let parsedStats = parts[1].trim().split(',').map(x => parseInt(x.trim()));
                        // Ensure it's an array of 3 numbers, default to 0 for missing/NaN values
                        stats = [
                            isNaN(parsedStats[0]) ? 0 : parsedStats[0],
                            isNaN(parsedStats[1]) ? 0 : parsedStats[1],
                            isNaN(parsedStats[2]) ? 0 : parsedStats[2]
                        ];
                        // If original parsing resulted in less than 3 items, fill remaining with 0
                        if (parsedStats.length < 3) {
                           for (let i = parsedStats.length; i < 3; i++) {
                               stats[i] = 0;
                           }
                        }
                    } catch (e) {
                        stats = [0, 0, 0]; // Default on error
                    }
                } else {
                    stats = [0, 0, 0]; // Default if only "|" is present or nothing after it
                }
            }
            
            if (main.includes(' - ')) {
                const [eng, kor] = main.split(' - ').map(x => x.trim());
                return [eng, kor, stats];
            }
            
            return [null, null, [0, 0, 0]];
        }

        function updateDaySelections() {
            const days = Object.keys(vocabulary).map(x => parseInt(x)).sort((a, b) => a - b);
            const singleSelect = document.getElementById('singleDay');
            const endSelect = document.getElementById('endDay');
            
            singleSelect.innerHTML = '';
            endSelect.innerHTML = '';
            
            days.forEach(day => {
                const option1 = new Option(`Day ${day}`, day);
                const option2 = new Option(`Day ${day}`, day);
                singleSelect.add(option1);
                endSelect.add(option2);
            });
            
            if (days.length > 0) {
                singleSelect.selectedIndex = 0;
                endSelect.selectedIndex = days.length - 1;
            }
        }

        function updateDaySelectionWidgets() {
            const mode = document.querySelector('input[name="learningMode"]:checked').value;
            const singleDay = document.getElementById('singleDay');
            const endDay = document.getElementById('endDay');
            const endDayLabel = document.getElementById('endDayLabel');
            
            if (mode === 'single') {
                singleDay.classList.remove('hidden');
                endDay.classList.add('hidden');
                endDayLabel.classList.add('hidden');
            } else {
                singleDay.classList.add('hidden');
                endDay.classList.remove('hidden');
                endDayLabel.classList.remove('hidden');
            }
        }

        function getWordsForCurrentMode() {
            const mode = document.querySelector('input[name="learningMode"]:checked').value;
            const days = Object.keys(vocabulary).map(x => parseInt(x)).sort((a, b) => a - b);
            
            if (days.length === 0) {
                alert('로드된 단어 데이터가 없습니다.');
                return null;
            }
            
            let words = [];
            let dayInfo = '';
            
            if (mode === 'single') {
                const selectedDay = parseInt(document.getElementById('singleDay').value);
                words = vocabulary[selectedDay] || [];
                dayInfo = `Day ${selectedDay}`;
            } else {
                const endDay = parseInt(document.getElementById('endDay').value);
                for (let day = 1; day <= endDay; day++) {
                    if (vocabulary[day]) {
                        words = words.concat(vocabulary[day]);
                    }
                }
                dayInfo = endDay === 1 ? 'Day 1' : `Day 1 ~ Day ${endDay}`;
            }
            
            if (words.length === 0) {
                alert('학습할 단어가 없습니다.');
                return null;
            }
            
            return { words, dayInfo };
        }

        function startStudyMode() {
            const result = getWordsForCurrentMode();
            if (!result) return;
            
            currentDayWords = [...result.words];
            shuffleArray(currentDayWords);
            currentWordIndex = 0;
            studyActive = true;
            quizActive = false;
            currentDayInfo = result.dayInfo;
            
            clearGameArea();
            document.getElementById('statusText').textContent = `--- ${currentDayInfo} 단어 학습 (${currentDayWords.length}개) ---`;
            
            setupStudyButtons();
            displayStudyWord();
        }

        function setupStudyButtons() {
            const button1 = document.getElementById('actionButton1');
            const button2 = document.getElementById('actionButton2');
            
            button1.textContent = '뜻 보기';
            button1.className = 'btn-action btn-submit';
            button1.onclick = showMeaning;
            button1.disabled = false;
            button1.classList.remove('hidden');
            
            button2.textContent = '다음 단어';
            button2.className = 'btn-action btn-next';
            button2.onclick = nextStudyWord;
            button2.disabled = true;
            button2.classList.remove('hidden');
        }

        function displayStudyWord() {
            if (currentWordIndex < currentDayWords.length) {
                const [eng, kor] = currentDayWords[currentWordIndex];
                updateStats(eng, kor, 0); // 학습횟수 증가
                const stats = getStats(eng, kor);
                
                document.getElementById('wordDisplay').textContent = `${currentWordIndex + 1}. ${eng}`;
                document.getElementById('meaningDisplay').textContent = `(학습:${stats[0]}, 퀴즈:${stats[1]}, 정답:${stats[2]})`;
                document.getElementById('feedback').textContent = '';
                
                document.getElementById('actionButton1').disabled = false;
                document.getElementById('actionButton2').disabled = true;
            } else {
                // 학습 완료
                document.getElementById('wordDisplay').textContent = '학습 완료! 🎉';
                document.getElementById('meaningDisplay').textContent = '';
                document.getElementById('statusText').textContent = `--- ${currentDayInfo} 학습 완료! ---`;
                document.getElementById('actionButton1').disabled = true;
                document.getElementById('actionButton2').disabled = true;
                studyActive = false;
            }
        }

        function showMeaning() {
            if (studyActive && currentWordIndex < currentDayWords.length) {
                const [, kor] = currentDayWords[currentWordIndex];
                document.getElementById('feedback').textContent = `→ ${kor}`;
                document.getElementById('feedback').className = 'feedback';
                document.getElementById('actionButton1').disabled = true;
                document.getElementById('actionButton2').disabled = false;
            }
        }

        function nextStudyWord() {
            if (studyActive) {
                currentWordIndex++;
                displayStudyWord();
            }
        }

        function startQuizMode() {
            const result = getWordsForCurrentMode();
            if (!result) return;
            
            currentDayWords = [...result.words];
            shuffleArray(currentDayWords);
            currentWordIndex = 0;
            score = 0;
            quizActive = true;
            studyActive = false;
            currentDayInfo = result.dayInfo;
            
            updateAchievementDisplay();
            
            activeQuestionType = document.querySelector('input[name="quizType"]:checked').value;
            displayQuizQuestion();
        }

        function displayQuizQuestion() {
            clearGameArea();
            
            if (currentWordIndex >= currentDayWords.length) {
                // 퀴즈 완료
                document.getElementById('wordDisplay').textContent = '퀴즈 완료! 🎉';
                document.getElementById('statusText').textContent = `--- ${currentDayInfo} 퀴즈 완료! ---`;
                document.getElementById('meaningDisplay').textContent = `점수: ${score}/${currentDayWords.length}`;
                return;
            }
            
            const [eng, kor] = currentDayWords[currentWordIndex];
            const stats = getStats(eng, kor);
            selectedOption = null;
            
            // mixed 모드일 경우 랜덤하게 퀴즈 타입 선택
            if (activeQuestionType === 'mixed') {
                const types = ['eng_to_kor', 'kor_to_eng', 'fill_blank'];
                activeQuestionType = types[Math.floor(Math.random() * types.length)];
            }
            
            document.getElementById('statusText').textContent = `--- ${currentDayInfo} 퀴즈 (${currentWordIndex + 1}/${currentDayWords.length}) ---`;
            document.getElementById('feedback').textContent = '';
            
            if (activeQuestionType === 'eng_to_kor') {
                setupEngToKorQuiz(eng, kor, stats);
            } else if (activeQuestionType === 'kor_to_eng') {
                setupKorToEngQuiz(eng, kor, stats);
            } else if (activeQuestionType === 'fill_blank') {
                setupFillBlankQuiz(eng, kor, stats);
            }
            
            setupQuizButtons();
        }

        function setupEngToKorQuiz(eng, kor, stats) {
            document.getElementById('wordDisplay').textContent = `${currentWordIndex + 1}. ${eng}`;
            document.getElementById('meaningDisplay').textContent = `(학습:${stats[0]}, 퀴즈:${stats[1]}, 정답:${stats[2]})`;
            
            const allKors = currentDayWords.map(([, k]) => k);
            const options = makeOptions(kor, allKors);
            createQuizOptions(options);
        }

        function setupKorToEngQuiz(eng, kor, stats) {
            document.getElementById('wordDisplay').textContent = `${currentWordIndex + 1}. ${kor}`;
            document.getElementById('meaningDisplay').textContent = `(학습:${stats[0]}, 퀴즈:${stats[1]}, 정답:${stats[2]})`;
            
            const allEngs = currentDayWords.map(([e]) => e);
            const options = makeOptions(eng, allEngs);
            createQuizOptions(options);
        }

        function setupFillBlankQuiz(eng, kor, stats) {
            const blankedWord = generateBlankedWord(eng);
            document.getElementById('wordDisplay').textContent = `${currentWordIndex + 1}. ${blankedWord}`;
            document.getElementById('meaningDisplay').textContent = `뜻: ${kor} (학습:${stats[0]}, 퀴즈:${stats[1]}, 정답:${stats[2]})`;
            
            const answerInput = document.getElementById('answerInput');
            answerInput.value = '';
            answerInput.classList.remove('hidden');
            answerInput.disabled = false;
            answerInput.focus();
        }

        function makeOptions(correct, allOptions, num = 4) {
            const options = [correct];
            const candidates = allOptions.filter(item => item !== correct);
            
            while (options.length < num && candidates.length > 0) {
                const randomIndex = Math.floor(Math.random() * candidates.length);
                options.push(candidates.splice(randomIndex, 1)[0]);
            }
            
            return shuffleArray(options);
        }

        function createQuizOptions(options) {
            const container = document.getElementById('quizOptions');
            container.innerHTML = '';
            container.classList.remove('hidden');
            
            options.forEach(option => {
                const button = document.createElement('button');
                button.className = 'quiz-option';
                button.textContent = option;
                button.onclick = () => selectOption(option, button);
                container.appendChild(button);
            });
        }

        function selectOption(option, button) {
            selectedOption = option;
            
            // 모든 옵션 스타일 리셋
            document.querySelectorAll('.quiz-option').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // 선택된 옵션 스타일 적용
            button.classList.add('selected');
            
            // 제출 버튼 활성화
            document.getElementById('actionButton1').disabled = false;
        }

        function setupQuizButtons() {
            const button1 = document.getElementById('actionButton1');
            const button2 = document.getElementById('actionButton2');
            
            button1.textContent = '제출';
            button1.className = 'btn-action btn-submit';
            button1.onclick = checkQuizAnswer;
            button1.disabled = activeQuestionType === 'fill_blank';
            button1.classList.remove('hidden');
            
            button2.textContent = '다음 문제';
            button2.className = 'btn-action btn-next';
            button2.onclick = nextQuizQuestion;
            button2.disabled = true;
            button2.classList.remove('hidden');
        }

        function checkQuizAnswer() {
            if (!quizActive || currentWordIndex >= currentDayWords.length) return;
            
            const [eng, kor] = currentDayWords[currentWordIndex];
            updateStats(eng, kor, 1); // 퀴즈 시도 횟수 증가
            
            let isCorrect = false;
            let correctAnswer = '';
            
            if (activeQuestionType === 'eng_to_kor') {
                if (selectedOption === null) {
                    showFeedback('옵션을 선택하고 제출해주세요.', 'warning');
                    return;
                }
                isCorrect = selectedOption === kor;
                correctAnswer = kor;
            } else if (activeQuestionType === 'kor_to_eng') {
                if (selectedOption === null) {
                    showFeedback('옵션을 선택하고 제출해주세요.', 'warning');
                    return;
                }
                isCorrect = selectedOption === eng;
                correctAnswer = eng;
            } else if (activeQuestionType === 'fill_blank') {
                const userAnswer = document.getElementById('answerInput').value.trim();
                if (!userAnswer) {
                    showFeedback('답을 입력하고 제출해주세요.', 'warning');
                    return;
                }
                isCorrect = userAnswer.toLowerCase() === eng.toLowerCase();
                correctAnswer = eng;
                document.getElementById('answerInput').disabled = true;
            }
            
            if (isCorrect) {
                showFeedback('정답! 🎉', 'correct');
                score++;
                updateStats(eng, kor, 2); // 정답횟수 증가
                
                // 성취점수 증가
                achievementScore++;
                achievementData.total = achievementScore;
                updateAchievementDisplay();
                saveToStorage();
            } else {
                showFeedback(`오답! 정답: ${correctAnswer}`, 'incorrect');
            }
            
            // 모든 옵션 버튼 비활성화
            document.querySelectorAll('.quiz-option').forEach(btn => {
                btn.disabled = true;
            });
            
            document.getElementById('actionButton1').disabled = true;
            document.getElementById('actionButton2').disabled = false;
        }

        function nextQuizQuestion() {
            if (quizActive) {
                currentWordIndex++;
                activeQuestionType = document.querySelector('input[name="quizType"]:checked').value;
                displayQuizQuestion();
            }
        }

        function showFeedback(message, type) {
            const feedback = document.getElementById('feedback');
            feedback.textContent = message;
            feedback.className = `feedback ${type}`;
        }

        function clearGameArea() {
            document.getElementById('wordDisplay').textContent = '';
            document.getElementById('meaningDisplay').textContent = '';
            document.getElementById('feedback').textContent = '';
            document.getElementById('quizOptions').classList.add('hidden');
            document.getElementById('answerInput').classList.add('hidden');
            document.getElementById('actionButton1').classList.add('hidden');
            document.getElementById('actionButton2').classList.add('hidden');
        }

        function onAnswerEntryChange() {
            if (quizActive && activeQuestionType === 'fill_blank') {
                const hasText = document.getElementById('answerInput').value.trim().length > 0;
                document.getElementById('actionButton1').disabled = !hasText;
            }
        }

        function generateBlankedWord(word) {
            if (word.length <= 3) {
                return '_'.repeat(word.length);
            }
            
            const numBlanks = Math.min(2, Math.floor(word.length / 3));
            const positions = [];
            
            while (positions.length < numBlanks) {
                const pos = Math.floor(Math.random() * word.length);
                if (!positions.includes(pos)) {
                    positions.push(pos);
                }
            }
            
            return word.split('').map((char, index) => 
                positions.includes(index) ? '_' : char
            ).join('');
        }

        function updateStats(eng, kor, statIdx) {
            const key = `${eng}|${kor}`;
            if (!statsData[key]) {
                statsData[key] = [0, 0, 0];
            }
            statsData[key][statIdx]++;
            saveToStorage();
        }

        function getStats(eng, kor) {
            const key = `${eng}|${kor}`;
            return statsData[key] || [0, 0, 0];
        }

        function updateAchievementDisplay() {
            document.getElementById('achievementScore').textContent = achievementScore;
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // 데이터 저장/로드
        function saveToStorage() {
            try {
                localStorage.setItem('vocabApp_vocabulary', JSON.stringify(vocabulary));
                localStorage.setItem('vocabApp_stats', JSON.stringify(statsData));
                localStorage.setItem('vocabApp_achievement', JSON.stringify(achievementData));
            } catch (e) {
                console.error('저장 실패:', e);
            }
        }

        function loadFromStorage() {
            try {
                const savedVocab = localStorage.getItem('vocabApp_vocabulary');
                const savedStats = localStorage.getItem('vocabApp_stats');
                const savedAchievement = localStorage.getItem('vocabApp_achievement');
                
                if (savedVocab) {
                    vocabulary = JSON.parse(savedVocab);
                    updateDaySelections();
                }
                
                if (savedStats) {
                    statsData = JSON.parse(savedStats);
                }
                
                if (savedAchievement) {
                    achievementData = JSON.parse(savedAchievement);
                    achievementScore = achievementData.total || 0;
                }
            } catch (e) {
                console.error('로드 실패:', e);
            }
        }

        // 페이지 종료 시 자동 저장
        window.addEventListener('beforeunload', saveToStorage);
    </script>
</body>
</html>
