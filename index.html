<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>단어 암기 앱</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 25px; /* MODIFIED from 30px */
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.2em; /* MODIFIED from 2.5em */
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .achievement-score {
            background: rgba(255,255,255,0.2);
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 600;
            font-size: 1.2em;
            backdrop-filter: blur(10px);
        }

        .content {
            padding: 25px; /* MODIFIED from 30px */
        }

        /* 설정 화면 스타일 */
        .settings-view {
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .settings-section {
            background: #f8f9ff;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid #e1e8ff;
        }

        .settings-title {
            font-size: 1.3em;
            color: #4a5568;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #2d3748;
            font-weight: 500;
        }

        .radio-group {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 8px;
            transition: background-color 0.2s;
        }

        .radio-option:hover {
            background-color: #e2e8f0;
        }

        .radio-option input[type="radio"] {
            margin: 0;
            cursor: pointer;
        }

        select {
            width: 100px;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            background: white;
            cursor: pointer;
            transition: border-color 0.2s;
        }

        select:focus {
            outline: none;
            border-color: #4facfe;
        }

        .quiz-type-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }

        .quiz-type-option {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .quiz-type-option:hover {
            border-color: #4facfe;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(79, 172, 254, 0.15);
        }

        .quiz-type-option.selected {
            border-color: #4facfe;
            background: #f0f9ff;
        }

        .buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 25px;
        }

        .btn {
            padding: 15px 25px;
            border: none;
            border-radius: 12px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(79, 172, 254, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(79, 172, 254, 0.6);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        /* 학습/퀴즈 화면 스타일 */
        .game-view {
            animation: fadeIn 0.3s ease-out;
        }

        .game-area {
            background: #f8f9ff;
            border-radius: 15px;
            padding: 25px; /* MODIFIED from 30px */
            text-align: center;
            min-height: 400px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            border: 1px solid #e1e8ff;
        }

        .status-text {
            font-size: 1.2em;
            color: #4a5568;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .word-display {
            font-size: 2.2em; /* MODIFIED from 2.5em */
            font-weight: bold;
            color: #2d3748;
            margin: 20px 0;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .meaning-display {
            font-size: 1.5em;
            color: #4a5568;
            margin: 15px 0;
        }

        .feedback {
            font-size: 1.2em;
            margin: 15px 0;
            font-weight: 600;
            min-height: 25px;
        }

        .feedback.correct {
            color: #48bb78;
        }

        .feedback.incorrect {
            color: #f56565;
        }

        .feedback.warning {
            color: #ed8936;
        }

        .quiz-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin: 25px 0;
        }

        .quiz-option {
            padding: 15px 25px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1.1em;
        }

        .quiz-option:hover {
            border-color: #4facfe;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(79, 172, 254, 0.15);
        }

        .quiz-option.selected {
            border-color: #4facfe;
            background: #f0f9ff;
        }

        .quiz-option:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .answer-input {
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1.3em;
            text-align: center;
            width: 100%;
            max-width: 300px;
            margin: 20px auto;
            transition: border-color 0.2s;
        }

        .answer-input:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }

        .game-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 25px;
            flex-wrap: wrap;
        }

        .btn-action {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 120px;
        }

        .btn-submit {
            background: #48bb78;
            color: white;
        }

        .btn-submit:hover:not(:disabled) {
            background: #38a169;
            transform: translateY(-1px);
        }

        .btn-submit:disabled {
            background: #a0aec0;
            cursor: not-allowed;
        }

        .btn-next {
            background: #4facfe;
            color: white;
        }

        .btn-next:hover:not(:disabled) {
            background: #2b6cb0;
            transform: translateY(-1px);
        }

        .btn-next:disabled {
            background: #a0aec0;
            cursor: not-allowed;
        }

        .btn-back {
            background: #718096;
            color: white;
            margin-top: 20px;
        }

        .btn-back:hover {
            background: #4a5568;
            transform: translateY(-1px);
        }

        #mainButtonsContainer {
            display: flex;
            justify-content: space-around; /* Or space-between, or use gap */
            align-items: center;
            padding: 20px 0; /* Add some padding */
            gap: 15px; /* Space between buttons */
        }

        #mainButtonsContainer .btn { /* Style for buttons within the main container */
            flex-grow: 1; /* Allow buttons to grow and fill space if needed */
            text-align: center;
        }


        @media (max-width: 600px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }

            .content {
                padding: 20px;
            }

            .buttons {
                grid-template-columns: 1fr;
            }

            .quiz-type-grid {
                grid-template-columns: 1fr;
            }

            .radio-group {
                flex-direction: column;
                gap: 10px;
            }

            .word-display {
                font-size: 2em;
            }

            .game-buttons {
                flex-direction: column;
                align-items: center;
            }
        }

        .hidden {
            display: none !important;
        }

        /* Quiz Mode Specific Styles for Reduced Whitespace */
        #game-area {
            padding: 15px 10px; /* Reduced padding: 15px top/bottom, 10px left/right */
        }

        .quiz-question-display { /* Container for the question text */
            margin-bottom: 15px; /* Space after the question block */
        }
        .quiz-question-display h3 {
            margin-top: 0;
            margin-bottom: 5px; /* Reduced margin for h3 */
            font-size: 1.25em;  /* Slightly smaller font for question title */
        }
        .quiz-question-display p {
            margin-bottom: 5px; /* Reduced margin for question paragraph */
            font-size: 0.95em;
            line-height: 1.4;
        }

        .quiz-options-list { /* Container for answer choice buttons */
            display: flex;
            flex-direction: column;
            gap: 6px; /* Reduced space between option buttons */
            margin-bottom: 15px; /* Space after the list of options */
        }
        .quiz-options-list button { /* Styling for each answer option button */
            padding: 10px 15px; /* Significantly reduced padding */
            font-size: 0.95em;  /* Slightly smaller font for options */
            width: 100%;
            text-align: left;
            box-sizing: border-box;
            /* Retain existing .btn styles for border-radius, transitions, etc.
               If options don't use .btn, add those styles here. */
        }

        #quiz-action-buttons { /* Container for Submit/Next Question buttons (referenced by ID) */
            margin-top: 10px; /* Reduced space above these action buttons */
            display: flex;
            gap: 8px; /* Reduced space between buttons */
            justify-content: flex-end;
        }
        #quiz-action-buttons .btn { /* If these buttons use the general .btn class */
            padding: 10px 18px; /* Reduced padding for these specific action buttons */
            font-size: 0.95em;
        }

        .quiz-feedback { /* Area for showing correct/incorrect feedback */
            margin-top: 10px;
            padding: 8px;
            font-size: 0.9em;
            min-height: auto; /* Allow it to shrink */
            border-radius: 6px;
        }
        .quiz-feedback.correct { background-color: #e6fffa; color: #23765a; border: 1px solid #a8e3d3; }
        .quiz-feedback.incorrect { background-color: #fff5f5; color: #c53030; border: 1px solid #fcb1b1; }

        /* Additional styles to hide images and reduce more whitespace in quiz mode */
        .quiz-mode .header {
            padding: 15px; /* Reduced header padding in quiz mode */
        }
        
        .quiz-mode .header h1 {
            font-size: 1.8em; /* Smaller title in quiz mode */
            margin-bottom: 5px;
        }
        
        .quiz-mode .achievement-score {
            padding: 5px 15px; /* Smaller achievement score area */
            font-size: 1em;
        }
        
        .quiz-mode .content {
            padding: 15px; /* Reduced content padding */
        }
        
        /* Hide images in quiz mode */
        .quiz-mode img, 
        .quiz-mode .header img,
        .quiz-mode .content img {
            display: none !important;
        }
        
        /* Reduce container padding in quiz mode */
        .quiz-mode .container {
            padding: 10px;
            max-width: 550px; /* Slightly smaller container */
        }
        
        /* Make quiz options more compact */
        .quiz-mode #quizOptions {
            margin-bottom: 10px;
        }
        
        .quiz-mode .quiz-option {
            padding: 8px 12px;
            margin-bottom: 5px;
        }
        
        /* Reduce status text size */
        .quiz-mode #statusText {
            font-size: 0.9em;
            margin: 5px 0;
        }

        /* 새로운 헤더 설정 버튼 스타일 */
        .header-back-btn {
            position: absolute;
            top: 20px; /* 위치 조정 */
            right: 20px; /* 위치 조정 */
            width: 40px;
            height: 40px;
            background-color: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 20px; /* 아이콘 크기 */
            line-height: 40px; /* 아이콘 수직 중앙 정렬 */
            text-align: center;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: background-color 0.3s, transform 0.2s;
        }

        .header-back-btn:hover {
            background-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        .header-back-btn.hidden {
            display: none;
        }

        .speaker-icon {
            font-size: 0.8em; /* Adjust as needed */
            margin-left: 8px;
            cursor: pointer;
            display: inline-block; /* To allow margin and proper placement */
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📚 단어 암기 앱</h1>
            <div class="achievement-score">
                🏆 성취점수: <span id="achievementScore">0</span>
            </div>
            <!-- 새로운 헤더 설정 아이콘 버튼 -->
            <button id="headerBackToSettingsBtn" class="header-back-btn hidden" onclick="backToSettings()">⚙️</button>
        </div>

        <div class="content">
            <!-- 설정 화면 -->
            <div class="settings-view" id="settingsView">
                <!-- Main Three Buttons -->
                <div id="mainButtonsContainer">
                    <button id="mainSettingsBtn" class="btn btn-primary">⚙️ 설정</button>
                    <button id="mainLearnBtn" class="btn btn-primary" onclick="startStudyMode()">📖 학습</button>
                    <button id="mainQuizBtn" class="btn btn-secondary" onclick="startQuizMode()">🧠 퀴즈</button>
                </div>

                <!-- Detailed Settings (initially hidden) -->
                <div id="detailedSettingsContainer" class="hidden">
                    <div class="settings-section">
                        <div class="settings-title">⚙️ 학습 설정</div>

                        <div class="form-group">
                            <label>학습 모드:</label>
                            <div class="radio-group">
                                <div class="radio-option">
                                    <input type="radio" name="learningMode" value="single" id="modeSingle" checked>
                                    <label for="modeSingle">일별 학습</label>
                                </div>
                                <div class="radio-option">
                                    <input type="radio" name="learningMode" value="comprehensive" id="modeComprehensive">
                                    <label for="modeComprehensive">종합 학습</label>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="singleDay">학습할 Day:</label>
                            <select id="singleDay"></select>

                            <label for="endDay" class="hidden" id="endDayLabel">종료 Day (시작: Day 1):</label>
                            <select id="endDay" class="hidden"></select>
                        </div>

                        <div class="form-group">
                            <label>퀴즈 유형:</label>
                            <div class="quiz-type-grid">
                                <div class="quiz-type-option selected" data-type="eng_to_kor">
                                    <input type="radio" name="quizType" value="eng_to_kor" checked hidden>
                                    영어 → 한글<br>(객관식)
                                </div>
                                <div class="quiz-type-option" data-type="kor_to_eng">
                                    <input type="radio" name="quizType" value="kor_to_eng" hidden>
                                    한글 → 영어<br>(객관식)
                                </div>
                                <div class="quiz-type-option" data-type="fill_blank">
                                    <input type="radio" name="quizType" value="fill_blank" hidden>
                                    빈칸 채우기<br>(주관식)
                                </div>
                                <div class="quiz-type-option" data-type="mixed">
                                    <input type="radio" name="quizType" value="mixed" hidden>
                                    종합 랜덤<br>(혼합)
                                </div>
                            </div>
                        </div> <!-- closes form-group for 퀴즈 유형 -->
                    </div> <!-- closes settings-section -->

                    <button id="backToMainButtonsBtn" class="btn btn-back" style="width:100%; margin-bottom:15px;">뒤로가기</button>
                </div>
            </div> <!-- closes settings-view -->

            <!-- 학습/퀴즈 화면 -->
            <div class="game-view hidden" id="gameView">
                <div class="game-area">
                    <div class="status-text" id="statusText">모드를 선택하세요</div>
                    <div class="word-display" id="wordDisplay"></div>
                    <div class="meaning-display" id="meaningDisplay"></div>
                    <div class="feedback" id="feedback"></div>
                    
                    <!-- 퀴즈 옵션 (객관식) -->
                    <div class="quiz-options hidden" id="quizOptions"></div>
                    
                    <!-- 답 입력 (주관식) -->
                    <input type="text" class="answer-input hidden" id="answerInput" placeholder="답을 입력하세요">
                    
                    <!-- 게임 버튼 -->
                    <div class="game-buttons">
                        <button class="btn-action btn-submit hidden" id="actionButton1"></button>
                        <button class="btn-action btn-next hidden" id="actionButton2"></button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 전역 변수
        let vocabulary = {};
        let statsData = {};
        // let achievementData = { total: 0 }; // Replaced by achievementScore directly
        let currentDayWords = [];
        let currentWordIndex = 0;
        let score = 0;
        let currentDayInfo = "";
        let quizActive = false;
        let studyActive = false;
        let activeQuestionType = null;
        let selectedOption = null;
        let achievementScore = 0;

        // --- localStorage 저장/로드 ---
        function saveStatsToStorage() {
            try {
                localStorage.setItem('vocab_stats', JSON.stringify(statsData));
                localStorage.setItem('vocab_achievement', achievementScore);
            } catch (e) {
                // 저장 실패 시 무시
            }
        }
        function loadStatsFromStorage() {
            try {
                const stats = localStorage.getItem('vocab_stats');
                if (stats) statsData = JSON.parse(stats);
                const ach = localStorage.getItem('vocab_achievement');
                if (ach !== null) { // Check for null to allow 0, e.g. if achievement is genuinely 0
                    achievementScore = parseInt(ach) || 0;
                } else {
                    achievementScore = 0; // Default if not found in localStorage
                }
            } catch (e) {
                // 로드 실패 시 무시
            }
        }

        // 초기화
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners(); // Set up UI event handlers
            loadStatsFromStorage(); // Load user statistics and achievement score from localStorage
            showMainButtons(); // Ensure main buttons are shown initially
            loadVocabularyFile(); // Load vocabulary data from file (or use sample data if not found)
            updateAchievementDisplay(); // Display the loaded achievement score
        });

        function setupEventListeners() {
            // 모드 변경
            document.querySelectorAll('input[name="learningMode"]').forEach(radio => {
                radio.addEventListener('change', updateDaySelectionWidgets);
            });
            
            // Main navigation buttons
            document.getElementById('mainSettingsBtn').addEventListener('click', showDetailedSettings);
            document.getElementById('backToMainButtonsBtn').addEventListener('click', showMainButtons);

            // 퀴즈 유형 선택
            document.querySelectorAll('.quiz-type-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.quiz-type-option').forEach(o => o.classList.remove('selected'));
                    this.classList.add('selected');
                    this.querySelector('input').checked = true;
                });
            });
            
            // 답 입력 필드
            document.getElementById('answerInput').addEventListener('input', onAnswerEntryChange);
            document.getElementById('answerInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !document.getElementById('actionButton1').disabled) {
                    document.getElementById('actionButton1').click();
                }
            });
        }

        // 화면 전환 함수
        function showGameView() {
            document.getElementById('settingsView').classList.add('hidden'); // Hide the entire settings area (main buttons and detailed)
            document.getElementById('gameView').classList.remove('hidden');
        }

        // New function to show detailed settings
        function showDetailedSettings() {
            document.getElementById('mainButtonsContainer').classList.add('hidden');
            document.getElementById('detailedSettingsContainer').classList.remove('hidden');
            // Ensure settingsView (parent) is visible if it was somehow hidden
            document.getElementById('settingsView').classList.remove('hidden');
        }

        // New function to show main buttons
        function showMainButtons() {
            document.getElementById('detailedSettingsContainer').classList.add('hidden');
            document.getElementById('mainButtonsContainer').classList.remove('hidden');
            // Ensure settingsView (parent) is visible
            document.getElementById('settingsView').classList.remove('hidden');
        }


        function backToSettings() {
            // 게임 상태 초기화
            quizActive = false;
            studyActive = false;
            currentWordIndex = 0;
            score = 0;
            
            // 퀴즈 모드 클래스 제거
            document.querySelector('.container').classList.remove('quiz-mode');
            console.log('퀴즈 모드 클래스 제거됨:', !document.querySelector('.container').classList.contains('quiz-mode'));
            
            // 새로운 헤더 설정 버튼 숨기기
            document.getElementById('headerBackToSettingsBtn').classList.add('hidden');
            
            // 화면 초기화
            clearGameArea();
            // showSettingsView(); // Old call
            showMainButtons(); // New Call: Show the main three-button screen

            // Ensure settingsView itself is visible if it was hidden
            document.getElementById('settingsView').classList.remove('hidden');
        }

        async function loadVocabularyFile() {
            try {
                const response = await fetch('vocabulary_list.txt');
                if (!response.ok) {
                    throw new Error('vocabulary_list.txt 파일을 찾을 수 없습니다.');
                }
                const content = await response.text();
                parseVocabularyData(content);
            } catch (error) {
                console.error('단어 파일 로드 실패:', error);
                // 파일이 없는 경우 샘플 데이터로 대체
                loadSampleData();
            }
        }

        function loadSampleData() {
            const sampleData = `Total Achievement | 0

Day 1
apple - 사과
book - 책
water - 물
house - 집
school - 학교

Day 2
computer - 컴퓨터
phone - 전화기
friend - 친구
family - 가족
love - 사랑

Day 3
beautiful - 아름다운
happy - 행복한
sad - 슬픈
angry - 화난
excited - 신난`;
            
            parseVocabularyData(sampleData);
        }

        function parseVocabularyData(content) {
            try {
                vocabulary = {}; // Initialize vocabulary object for the current session
                // statsData is preserved (loaded from localStorage or initialized as {}).
                // achievementScore is preserved (loaded from localStorage or initialized to 0).
                
                const lines = content.split('\n'); // Process the vocabulary file line by line
                let currentDay = null;
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;
                    
                    // Handle the 'Total Achievement' line
                    if (line.startsWith('Total Achievement')) {
                        try {
                            // Priority to localStorage: If 'vocab_achievement' was present in localStorage,
                            // its value (loaded into `achievementScore` by `loadStatsFromStorage`) is kept.
                            // The file's 'Total Achievement' is only used if no score was found in localStorage.
                            if (localStorage.getItem('vocab_achievement') === null) {
                                const scoreFromFile = parseInt(line.split('|')[1].trim());
                                if (!isNaN(scoreFromFile)) {
                                    achievementScore = scoreFromFile; // Set initial score from file
                                }
                            }
                        } catch (e) {
                            // Silently ignore errors in parsing Total Achievement; score remains as loaded or default.
                        }
                    // Handle 'Day X' lines to categorize words
                    } else if (line.toLowerCase().startsWith('day')) {
                        try {
                            const dayNum = parseInt(line.split(' ').pop());
                            currentDay = dayNum; // Set current day context for subsequent word lines
                            vocabulary[currentDay] = []; // Initialize array for this day's words
                        } catch (e) {
                            currentDay = null; // Invalid day line
                        }
                    // Handle word lines (e.g., "apple - 사과 | 0,0,0")
                    } else if (currentDay !== null && line.includes(' - ')) {
                        const [eng, kor, statsFromFile] = parseVocabLine(line); // Parse individual word, meaning, and stats
                        if (eng && kor) {
                            vocabulary[currentDay].push([eng, kor]); // Add word pair to current day's list
                            const key = `${eng}|${kor}`;
                            // Initialize stats for this word from the file ONLY IF
                            // it wasn't already loaded from localStorage (via statsData).
                            if (!statsData[key]) {
                                statsData[key] = statsFromFile;
                            }
                        }
                    }
                }
                
                updateDaySelections(); // Populate Day selection dropdowns in settings
                updateAchievementDisplay();
                
                console.log('단어 데이터가 성공적으로 로드되었습니다!');
            } catch (error) {
                console.error('파일 형식 오류:', error);
                // 에러 발생 시 샘플 데이터로 대체
                loadSampleData();
            }
        }

        // Parses a single line from the vocabulary file to extract English word, Korean meaning, and optional stats.
        // Example line: "apple - 사과 | 1,2,0" (eng - kor | study,quiz,correct stats)
        // Returns [eng, kor, stats_array] or [null, null, [0,0,0]] if parsing fails.
        function parseVocabLine(line) {
            let main = line; // Part of the line with eng - kor
            let stats = [0, 0, 0]; // Default stats

            // Check if stats are provided (separated by '|')
            if (line.includes('|')) {
                const parts = line.split('|');
                main = parts[0].trim();
                if (parts[1]) {
                    try {
                        const arr = parts[1].trim().split(',').map(x => parseInt(x));
                        if (arr.length === 3 && arr.every(x => Number.isFinite(x))) {
                            stats = arr;
                        }
                    } catch (e) {
                        stats = [0, 0, 0];
                    }
                }
            }

            if (main.includes(' - ')) {
                const [eng, kor] = main.split(' - ').map(x => x.trim());
                // XSS 방지: innerHTML 대신 textContent만 사용
                // 정규식 제거: 단어/뜻이 비어있지 않으면 모두 허용
                if (eng && kor) {
                    return [eng, kor, stats];
                }
            }
            return [null, null, [0, 0, 0]];
        }

        function updateDaySelections() {
            const days = Object.keys(vocabulary).map(x => parseInt(x)).sort((a, b) => a - b);
            const singleSelect = document.getElementById('singleDay');
            const endSelect = document.getElementById('endDay');
            
            singleSelect.innerHTML = '';
            endSelect.innerHTML = '';
            
            days.forEach(day => {
                const option1 = new Option(`Day ${day}`, day);
                const option2 = new Option(`Day ${day}`, day);
                singleSelect.add(option1);
                endSelect.add(option2);
            });
            
            if (days.length > 0) {
                singleSelect.selectedIndex = 0;
                endSelect.selectedIndex = days.length - 1;
            }
        }

        function updateDaySelectionWidgets() {
            const mode = document.querySelector('input[name="learningMode"]:checked').value;
            const singleDay = document.getElementById('singleDay');
            const endDay = document.getElementById('endDay');
            const endDayLabel = document.getElementById('endDayLabel');
            
            if (mode === 'single') {
                singleDay.classList.remove('hidden');
                endDay.classList.add('hidden');
                endDayLabel.classList.add('hidden');
            } else {
                singleDay.classList.add('hidden');
                endDay.classList.remove('hidden');
                endDayLabel.classList.remove('hidden');
            }
        }

        function getWordsForCurrentMode() {
            const mode = document.querySelector('input[name="learningMode"]:checked').value;
            const days = Object.keys(vocabulary).map(x => parseInt(x)).sort((a, b) => a - b);
            
            if (days.length === 0) {
                alert('로드된 단어 데이터가 없습니다.');
                return null;
            }
            
            let words = [];
            let dayInfo = '';
            
            if (mode === 'single') {
                const selectedDay = parseInt(document.getElementById('singleDay').value);
                words = vocabulary[selectedDay] || [];
                dayInfo = `Day ${selectedDay}`;
            } else {
                const endDay = parseInt(document.getElementById('endDay').value);
                for (let day = 1; day <= endDay; day++) {
                    if (vocabulary[day]) {
                        words = words.concat(vocabulary[day]);
                    }
                }
                dayInfo = endDay === 1 ? 'Day 1' : `Day 1 ~ Day ${endDay}`;
            }
            
            if (words.length === 0) {
                alert('학습할 단어가 없습니다.');
                return null;
            }
            
            return { words, dayInfo };
        }

        function startStudyMode() {
            const result = getWordsForCurrentMode();
            if (!result) return;
            
            currentDayWords = [...result.words];
            currentWordIndex = 0;
            studyActive = true;
            quizActive = false;
            currentDayInfo = result.dayInfo;
            
            // 화면 전환
            showGameView();
            updateAchievementDisplay();
            
            // 새로운 헤더 설정 버튼 표시
            document.getElementById('headerBackToSettingsBtn').classList.remove('hidden');
            
            setupStudyButtons(); // 버튼 초기화 함수 호출
            displayStudyWord();
        }

        function setupStudyButtons() {
            const button1 = document.getElementById('actionButton1');
            const button2 = document.getElementById('actionButton2');
            
            button1.textContent = '뜻 보기';
            button1.className = 'btn-action btn-submit';
            button1.onclick = showMeaning;
            button1.disabled = false;
            button1.classList.remove('hidden');
            
            button2.textContent = '다음 단어';
            button2.className = 'btn-action btn-next';
            button2.onclick = nextStudyWord;
            button2.disabled = true;
            button2.classList.remove('hidden');
        }

        function displayStudyWord() {
            if (currentWordIndex < currentDayWords.length) {
                const [eng, kor] = currentDayWords[currentWordIndex];
                updateStats(eng, kor, 0);
                const stats = getStats(eng, kor);

                const wordDisplayElement = document.getElementById('wordDisplay');
                wordDisplayElement.innerHTML = ''; // Clear previous content

                // Display word number and English word
                const wordText = document.createTextNode(`${currentWordIndex + 1}. ${eng} `); // Add space for icon
                wordDisplayElement.appendChild(wordText);

                // Add speaker icon only in study mode
                if (studyActive && !quizActive) { // Ensure it's study mode
                    const speakerIcon = document.createElement('span');
                    speakerIcon.textContent = '🔊'; // Speaker emoji or use an icon class
                    speakerIcon.className = 'speaker-icon'; // Apply CSS class
                    speakerIcon.title = 'Pronounce word'; // Tooltip

                    speakerIcon.onclick = function(event) {
                        event.stopPropagation(); // Prevent any parent click events
                        pronounceWord(eng);
                    };
                    wordDisplayElement.appendChild(speakerIcon);
                }
                
                document.getElementById('meaningDisplay').textContent = `(학습:${stats[0]}, 퀴즈:${stats[1]}, 정답:${stats[2]})`;
                document.getElementById('feedback').textContent = '';
                document.getElementById('statusText').textContent = `--- ${currentDayInfo} 학습 중 (${currentWordIndex + 1}/${currentDayWords.length}) ---`;
                
                document.getElementById('actionButton1').disabled = false;
                document.getElementById('actionButton2').disabled = true;
            } else {
                // 학습 완료
                document.getElementById('wordDisplay').textContent = '학습 완료! 🎉';
                document.getElementById('meaningDisplay').textContent = '';
                document.getElementById('statusText').textContent = `--- ${currentDayInfo} 학습 완료! ---`;
                document.getElementById('actionButton1').disabled = true;
                document.getElementById('actionButton2').disabled = true;
                studyActive = false;
            }
        }

        function showMeaning() {
            if (studyActive && currentWordIndex < currentDayWords.length) {
                const [, kor] = currentDayWords[currentWordIndex];
                document.getElementById('feedback').textContent = `→ ${kor}`;
                document.getElementById('feedback').className = 'feedback';
                document.getElementById('actionButton1').disabled = true;
                document.getElementById('actionButton2').disabled = false;
            }
        }

        function nextStudyWord() {
            if (studyActive) {
                currentWordIndex++;
                displayStudyWord();
            }
        }

        function startQuizMode() {
            const result = getWordsForCurrentMode();
            if (!result) return;
            
            currentDayWords = [...result.words];
            shuffleArray(currentDayWords);
            currentWordIndex = 0;
            score = 0;
            quizActive = true;
            studyActive = false;
            currentDayInfo = result.dayInfo;
            
            // 화면 전환
            showGameView();
            updateAchievementDisplay();
            
            // 퀴즈 모드 클래스 추가
            document.querySelector('.container').classList.add('quiz-mode');
            console.log('퀴즈 모드 클래스 추가됨:', document.querySelector('.container').classList.contains('quiz-mode'));
            
            // 새로운 헤더 설정 버튼 표시
            document.getElementById('headerBackToSettingsBtn').classList.remove('hidden');
            
            activeQuestionType = document.querySelector('input[name="quizType"]:checked').value;
            displayQuizQuestion();
        }

        function displayQuizQuestion() {
            clearGameArea();
            
            if (currentWordIndex >= currentDayWords.length) {
                // 퀴즈 완료
                document.getElementById('wordDisplay').textContent = '퀴즈 완료! 🎉';
                document.getElementById('statusText').textContent = `--- ${currentDayInfo} 퀴즈 완료! ---`;
                document.getElementById('meaningDisplay').textContent = `점수: ${score}/${currentDayWords.length}`;
                return;
            }
            
            const [eng, kor] = currentDayWords[currentWordIndex];
            const stats = getStats(eng, kor);
            selectedOption = null;
            
            // mixed 모드일 경우 랜덤하게 퀴즈 타입 선택
            if (activeQuestionType === 'mixed') {
                const types = ['eng_to_kor', 'kor_to_eng', 'fill_blank'];
                activeQuestionType = types[Math.floor(Math.random() * types.length)];
            }
            
            document.getElementById('statusText').textContent = `--- ${currentDayInfo} 퀴즈 (${currentWordIndex + 1}/${currentDayWords.length}) ---`;
            document.getElementById('feedback').textContent = '';
            
            if (activeQuestionType === 'eng_to_kor') {
                setupEngToKorQuiz(eng, kor, stats);
            } else if (activeQuestionType === 'kor_to_eng') {
                setupKorToEngQuiz(eng, kor, stats);
            } else if (activeQuestionType === 'fill_blank') {
                setupFillBlankQuiz(eng, kor, stats);
            }
            
            setupQuizButtons();
        }

        function setupEngToKorQuiz(eng, kor, stats) {
            document.getElementById('wordDisplay').textContent = `${currentWordIndex + 1}. ${eng}`;
            document.getElementById('meaningDisplay').textContent = `(학습:${stats[0]}, 퀴즈:${stats[1]}, 정답:${stats[2]})`;
            
            const allKors = currentDayWords.map(([, k]) => k);
            const options = makeOptions(kor, allKors);
            createQuizOptions(options);
        }

        function setupKorToEngQuiz(eng, kor, stats) {
            document.getElementById('wordDisplay').textContent = `${currentWordIndex + 1}. ${kor}`;
            document.getElementById('meaningDisplay').textContent = `(학습:${stats[0]}, 퀴즈:${stats[1]}, 정답:${stats[2]})`;
            
            const allEngs = currentDayWords.map(([e]) => e);
            const options = makeOptions(eng, allEngs);
            createQuizOptions(options);
        }

        function setupFillBlankQuiz(eng, kor, stats) {
            const blankedWord = generateBlankedWord(eng);
            document.getElementById('wordDisplay').textContent = `${currentWordIndex + 1}. ${blankedWord}`;
            document.getElementById('meaningDisplay').textContent = `뜻: ${kor} (학습:${stats[0]}, 퀴즈:${stats[1]}, 정답:${stats[2]})`;
            
            const answerInput = document.getElementById('answerInput');
            answerInput.value = '';
            answerInput.classList.remove('hidden');
            answerInput.disabled = false;
            answerInput.focus();
        }

        function makeOptions(correct, allOptions, num = 4) {
            const options = [correct];
            const candidates = allOptions.filter(item => item !== correct);
            
            while (options.length < num && candidates.length > 0) {
                const randomIndex = Math.floor(Math.random() * candidates.length);
                options.push(candidates.splice(randomIndex, 1)[0]);
            }
            
            return shuffleArray(options);
        }

        function createQuizOptions(options) {
            const container = document.getElementById('quizOptions');
            container.innerHTML = '';
            container.classList.remove('hidden');
            
            options.forEach(option => {
                const button = document.createElement('button');
                button.className = 'quiz-option';
                button.textContent = option;
                button.onclick = () => selectOption(option, button);
                container.appendChild(button);
            });
        }

        function selectOption(option, button) {
            selectedOption = option;
            
            // 모든 옵션 스타일 리셋
            document.querySelectorAll('.quiz-option').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // 선택된 옵션 스타일 적용
            button.classList.add('selected');
            
            // 제출 버튼 활성화
            document.getElementById('actionButton1').disabled = false;
        }

        function setupQuizButtons() {
            const button1 = document.getElementById('actionButton1');
            const button2 = document.getElementById('actionButton2');
            
            button1.textContent = '제출';
            button1.className = 'btn-action btn-submit';
            button1.onclick = checkQuizAnswer;
            button1.disabled = activeQuestionType === 'fill_blank';
            button1.classList.remove('hidden');
            
            button2.textContent = '다음 문제';
            button2.className = 'btn-action btn-next';
            button2.onclick = nextQuizQuestion;
            button2.disabled = true;
            button2.classList.remove('hidden');
        }

        function checkQuizAnswer() {
            if (!quizActive || currentWordIndex >= currentDayWords.length) return;
            
            const [eng, kor] = currentDayWords[currentWordIndex];
            updateStats(eng, kor, 1); // 퀴즈 시도 횟수 증가
            
            let isCorrect = false;
            let correctAnswer = '';
            
            if (activeQuestionType === 'eng_to_kor') {
                if (selectedOption === null) {
                    showFeedback('옵션을 선택하고 제출해주세요.', 'warning');
                    return;
                }
                isCorrect = selectedOption === kor;
                correctAnswer = kor;
            } else if (activeQuestionType === 'kor_to_eng') {
                if (selectedOption === null) {
                    showFeedback('옵션을 선택하고 제출해주세요.', 'warning');
                    return;
                }
                isCorrect = selectedOption === eng;
                correctAnswer = eng;
            } else if (activeQuestionType === 'fill_blank') {
                const userAnswer = document.getElementById('answerInput').value.trim();
                if (!userAnswer) {
                    showFeedback('답을 입력하고 제출해주세요.', 'warning');
                    return;
                }
                isCorrect = userAnswer.toLowerCase() === eng.toLowerCase();
                correctAnswer = eng;
                document.getElementById('answerInput').disabled = true;
            }
            
            if (isCorrect) {
                showFeedback('정답! 🎉', 'correct');
                score++;
                updateStats(eng, kor, 2); // 정답횟수 증가
                
                // 성취점수 증가
                achievementScore++; // Directly increment achievementScore
                updateAchievementDisplay();
                // 메모리에만 저장 (세션 동안 유지)
            } else {
                showFeedback(`오답! 정답: ${correctAnswer}`, 'incorrect');
            }
            
            // 모든 옵션 버튼 비활성화
            document.querySelectorAll('.quiz-option').forEach(btn => {
                btn.disabled = true;
            });
            
            document.getElementById('actionButton1').disabled = true;
            document.getElementById('actionButton2').disabled = false;
        }

        function nextQuizQuestion() {
            if (quizActive) {
                currentWordIndex++;
                activeQuestionType = document.querySelector('input[name="quizType"]:checked').value;
                displayQuizQuestion();
            }
        }

        function showFeedback(message, type) {
            const feedback = document.getElementById('feedback');
            feedback.textContent = message;
            feedback.className = `feedback ${type}`;
        }

        function clearGameArea() {
            document.getElementById('wordDisplay').textContent = '';
            document.getElementById('meaningDisplay').textContent = '';
            document.getElementById('feedback').textContent = '';
            document.getElementById('quizOptions').classList.add('hidden');
            document.getElementById('answerInput').classList.add('hidden');
            document.getElementById('actionButton1').classList.add('hidden');
            document.getElementById('actionButton2').classList.add('hidden');
        }

        function onAnswerEntryChange() {
            if (quizActive && activeQuestionType === 'fill_blank') {
                const hasText = document.getElementById('answerInput').value.trim().length > 0;
                document.getElementById('actionButton1').disabled = !hasText;
            }
        }

        function generateBlankedWord(word) {
            if (word.length <= 3) {
                return '_'.repeat(word.length);
            }
            
            const numBlanks = Math.min(2, Math.floor(word.length / 3));
            const positions = [];
            
            while (positions.length < numBlanks) {
                const pos = Math.floor(Math.random() * word.length);
                if (!positions.includes(pos)) {
                    positions.push(pos);
                }
            }
            
            return word.split('').map((char, index) => 
                positions.includes(index) ? '_' : char
            ).join('');
        }

        // --- 통계 조회 함수 ---
        function getStats(eng, kor) {
            const key = `${eng}|${kor}`;
            return statsData[key] || [0, 0, 0]; // Return default [0,0,0] if not found
        }

        // --- 통계/성취점수 변경 시 저장 ---
        function updateStats(eng, kor, statIdx) {
            const key = `${eng}|${kor}`;
            if (!statsData[key] || !Array.isArray(statsData[key]) || statsData[key].length !== 3) {
                statsData[key] = [0, 0, 0];
            }
            statsData[key][statIdx]++;
            saveStatsToStorage();
        }
        function updateAchievementDisplay() {
            document.getElementById('achievementScore').textContent = achievementScore;
            saveStatsToStorage();
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function pronounceWord(word) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(word);
                utterance.lang = 'en-US'; // Set language to US English
                // Optional: Adjust rate, pitch, volume
                // utterance.rate = 1.0;
                // utterance.pitch = 1.0;
                // utterance.volume = 1.0;
                window.speechSynthesis.speak(utterance);
            } else {
                console.warn('Web Speech API (Text-to-Speech) not supported in this browser.');
                // Optionally, provide a fallback or user message here
                alert('이 브라우저에서는 단어 발음 기능을 지원하지 않습니다.');
            }
        }
    </script>
</body>
</html>
